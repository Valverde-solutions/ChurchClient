@page "/clients"
@using MediatR
@using ChurchSaaS.Admin.Application.Queries.ChurchClients
@using ChurchSaaS.Admin.Domain.Churches
@using ChurchSaaS.Admin.Domain.Entities
@inject ISender Sender
@inject ISnackbar Snackbar

<PageTitle>Clientes</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="mt-6">
    <MudPaper Elevation="1" Class="pa-4">
        <MudStack Spacing="3">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <div>
                    <MudText Typo="Typo.h6">Clientes</MudText>
                    <MudText Typo="Typo.caption" Class="text-muted">Visao geral dos clientes cadastrados.</MudText>
                </div>
                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                    <MudTextField @bind-Value="_search"
                                  Placeholder="Buscar por nome, email ou plano"
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Margin="Margin.Dense"
                                  Class="search-input" />
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               Disabled="true">
                        Novo cliente
                    </MudButton>
                </MudStack>
            </MudStack>

            <MudTable Items="_clients"
                      Hover="true"
                      Dense="true"
                      Loading="_isLoading"
                      Filter="FilterClients"
                      Elevation="0"
                      Bordered="false"
                      Striped="true">
                <HeaderContent>
                    <MudTh>Cliente</MudTh>
                    <MudTh>Contato</MudTh>
                    <MudTh>Plano</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Datas</MudTh>
                    <MudTh>Documento</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Cliente">
                        <MudText Typo="Typo.subtitle2">@context.DisplayName</MudText>
                        @if (!string.Equals(context.DisplayName, context.LegalName, StringComparison.OrdinalIgnoreCase))
                        {
                            <MudText Typo="Typo.caption" Class="text-muted">@context.LegalName</MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Contato">
                        <MudText Typo="Typo.body2">@context.ContactName</MudText>
                        <MudText Typo="Typo.caption">@context.ContactEmail</MudText>
                        @if (!string.IsNullOrWhiteSpace(context.ContactPhone))
                        {
                            <MudText Typo="Typo.caption">@context.ContactPhone</MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Plano">
                        <MudChip T="string" Color="Color.Info" Variant="Variant.Outlined" Size="Size.Small">@context.PlanCode</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Status">
                        @{
                            var statusInfo = GetStatusInfo(context.Status);
                        }
                        <MudChip T="string" Color="statusInfo.Color" Variant="Variant.Filled" Size="Size.Small">@statusInfo.Label</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Datas">
                        <MudText Typo="Typo.caption">Criado: @context.CreatedAt.LocalDateTime.ToString("dd/MM/yyyy")</MudText>
                        <MudText Typo="Typo.caption">Trial ate: @(context.TrialEndsAt.HasValue ? context.TrialEndsAt.Value.LocalDateTime.ToString("dd/MM/yyyy") : "-")</MudText>
                        <MudText Typo="Typo.caption">Ativo em: @(context.ActivatedAt.HasValue ? context.ActivatedAt.Value.LocalDateTime.ToString("dd/MM/yyyy") : "-")</MudText>
                    </MudTd>
                    <MudTd DataLabel="Documento">
                        @if (!string.IsNullOrWhiteSpace(context.Document))
                        {
                            <MudText Typo="Typo.body2">@context.Document</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Class="text-muted">-</MudText>
                        }
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudStack Spacing="1" Class="pa-4" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Groups" Color="Color.Default" Size="Size.Large" />
                        <MudText Typo="Typo.body2" Class="text-muted">Nenhum cliente cadastrado ainda.</MudText>
                    </MudStack>
                </NoRecordsContent>
            </MudTable>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private bool _isLoading = true;
    private string _search = string.Empty;
    private List<ClientViewModel> _clients = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadClients();
    }

    private async Task LoadClients()
    {
        _isLoading = true;
        var result = await Sender.Send(new ListChurchClientsQuery());
        if (result.Success && result.Data is not null)
        {
            _clients = result.Data.Select(MapToViewModel).ToList();
        }
        else
        {
            var message = result.Message ?? "Nao foi possivel carregar os clientes.";
            Snackbar.Add(message, Severity.Error);
        }

        _isLoading = false;
    }

    private static ClientViewModel MapToViewModel(ChurchClient client)
    {
        return new ClientViewModel(
            client.Id,
            client.TradeName ?? client.LegalName,
            client.LegalName,
            client.MainContactName,
            client.MainContactEmail.Value,
            client.MainContactPhone?.Value,
            client.PlanCode,
            client.Status,
            client.CreatedAt,
            client.TrialEndsAt,
            client.ActivatedAt,
            client.Document?.Value);
    }

    private bool FilterClients(ClientViewModel client)
    {
        if (string.IsNullOrWhiteSpace(_search))
            return true;

        var term = _search.Trim();

        return client.DisplayName.Contains(term, StringComparison.OrdinalIgnoreCase)
               || client.ContactEmail.Contains(term, StringComparison.OrdinalIgnoreCase)
               || client.PlanCode.Contains(term, StringComparison.OrdinalIgnoreCase)
               || (!string.IsNullOrWhiteSpace(client.Document) && client.Document.Contains(term, StringComparison.OrdinalIgnoreCase));
    }

    private static (Color Color, string Label) GetStatusInfo(ChurchClientStatus status)
    {
        return status switch
        {
            ChurchClientStatus.PendingProvisioning => (Color.Warning, "Pendente"),
            ChurchClientStatus.Active => (Color.Success, "Ativo"),
            ChurchClientStatus.Suspended => (Color.Info, "Suspenso"),
            ChurchClientStatus.Cancelled => (Color.Error, "Cancelado"),
            _ => (Color.Default, "Rascunho")
        };
    }

    private sealed record ClientViewModel(
        Guid Id,
        string DisplayName,
        string LegalName,
        string ContactName,
        string ContactEmail,
        string? ContactPhone,
        string PlanCode,
        ChurchClientStatus Status,
        DateTimeOffset CreatedAt,
        DateTimeOffset? TrialEndsAt,
        DateTimeOffset? ActivatedAt,
        string? Document);
}
