@page "/plans"
@using MediatR
@using System.ComponentModel.DataAnnotations
@inject ISender Sender
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@using ChurchSaaS.Admin.Web.Components.Dialogs

<PageTitle>Planos</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="mt-6">
    <MudGrid Spacing="3">
        <MudItem xs="12">
            <MudPaper Elevation="1" Class="pa-4 h-100">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <div>
                            <MudText Typo="Typo.h6">Planos</MudText>
                            <MudText Typo="Typo.caption" Class="text-muted">Visão geral dos planos disponíveis.</MudText>
                        </div>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenCreateModal" StartIcon="@Icons.Material.Filled.Add">
                            Adicionar plano
                        </MudButton>
                    </MudStack>
                    <MudTable Items="_plans" Dense="true" Hover="true" Loading="_isLoading" Bordered="false" Striped="true">
                        <HeaderContent>
                            <MudTh>Código</MudTh>
                            <MudTh>Nome</MudTh>
                            <MudTh>Preço base</MudTh>
                            <MudTh>Módulos</MudTh>
                            <MudTh>Limites</MudTh>
                            <MudTh>Ações</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Código">@context.Code</MudTd>
                            <MudTd DataLabel="Nome">@context.Name</MudTd>
                            <MudTd DataLabel="Preço base">@context.BasePrice.ToString("C")</MudTd>
                            <MudTd DataLabel="Módulos">
                                <MudChipSet T="string">
                                    @foreach (var chip in context.Modules)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">@chip</MudChip>
                                    }
                                </MudChipSet>
                            </MudTd>
                            <MudTd DataLabel="Limites">
                                <MudText Typo="Typo.caption">Locatários: @(context.MaxTenants?.ToString() ?? "Ilimitado")</MudText><br />
                                <MudText Typo="Typo.caption">Membros: @(context.MaxMembers?.ToString() ?? "Ilimitado")</MudText>
                            </MudTd>
                            <MudTd DataLabel="Ações">
                                <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Primary" OnClick="@(() => StartEdit(context))">Editar</MudButton>
                            </MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText Typo="Typo.body2" Class="text-muted">Nenhum plano cadastrado ainda.</MudText>
                        </NoRecordsContent>
                    </MudTable>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private bool _isSubmitting;
    private bool _isLoading = true;
    private List<PlanViewModel> _plans = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadPlans();
    }

    private async Task LoadPlans()
    {
        _isLoading = true;
        var result = await Sender.Send(new ChurchSaaS.Admin.Application.Queries.Plans.ListPlansQuery());
        if (result.Success && result.Data is not null)
        {
            _plans = result.Data
                .Select(p => new PlanViewModel(
                    p.Code,
                    p.Name,
                    p.Description,
                    p.BasePrice,
                    p.PricePerAdditionalTenant,
                    p.PricePerAdditionalMember,
                    p.MaxTenants,
                    p.MaxMembers,
                    ModulesFromPlan(p),
                    p.HasFinance,
                    p.HasEvents,
                    p.HasCommunication,
                    p.HasKidsCheckin))
                .ToList();
        }
        else
        {
            Snackbar.Add(result.Message ?? "Não foi possível carregar os planos.", Severity.Error);
        }
        _isLoading = false;
    }

    private static IEnumerable<string> ModulesFromPlan(ChurchSaaS.Admin.Domain.Entities.Plan p)
    {
        if (p.HasFinance) yield return "Financeiro";
        if (p.HasEvents) yield return "Eventos";
        if (p.HasCommunication) yield return "Comunicação";
        if (p.HasKidsCheckin) yield return "Check-in infantil";
    }

    private async Task OpenCreateModal()
    {
        var model = new PlanDialogModel
        {
            HasFinance = true,
            HasEvents = true,
            HasCommunication = true,
            HasKidsCheckin = false
        };

        await OpenPlanDialog(model, isEdit: false);
    }

    private async Task StartEdit(PlanViewModel plan)
    {
        var model = new PlanDialogModel
        {
            Code = plan.Code,
            Name = plan.Name,
            Description = plan.Description,
            BasePrice = plan.BasePrice,
            PricePerAdditionalTenant = plan.PricePerAdditionalTenant,
            PricePerAdditionalMember = plan.PricePerAdditionalMember,
            MaxTenants = plan.MaxTenants,
            MaxMembers = plan.MaxMembers,
            HasFinance = plan.HasFinance,
            HasEvents = plan.HasEvents,
            HasCommunication = plan.HasCommunication,
            HasKidsCheckin = plan.HasKidsCheckin
        };

        await OpenPlanDialog(model, isEdit: true);
    }

    private async Task OpenPlanDialog(PlanDialogModel model, bool isEdit)
    {
        var parameters = new DialogParameters
        {
            { nameof(PlanDialog.Model), model },
            { nameof(PlanDialog.IsEdit), isEdit }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = DialogService.Show<PlanDialog>(isEdit ? "Editar plano" : "Adicionar plano", parameters, options);
        var result = await dialog.Result;

        if (result.Canceled || result.Data is not PlanDialogModel submitted)
            return;

        _isSubmitting = true;

        if (isEdit)
        {
            var updateCommand = new ChurchSaaS.Admin.Application.Commands.Plans.UpdatePlanCommand(
                submitted.Code ?? string.Empty,
                submitted.Name ?? string.Empty,
                submitted.Description,
                submitted.BasePrice,
                submitted.PricePerAdditionalTenant,
                submitted.PricePerAdditionalMember,
                submitted.MaxTenants,
                submitted.MaxMembers,
                submitted.HasFinance,
                submitted.HasEvents,
                submitted.HasCommunication,
                submitted.HasKidsCheckin,
                "web");

            var updateResult = await Sender.Send(updateCommand);
            HandleResult(updateResult.Success, "Plano atualizado.", updateResult.Errors, updateResult.Message);
        }
        else
        {
            var createCommand = new ChurchSaaS.Admin.Application.Commands.Plans.CreatePlanCommand(
                submitted.Code ?? string.Empty,
                submitted.Name ?? string.Empty,
                submitted.Description,
                submitted.BasePrice,
                submitted.PricePerAdditionalTenant,
                submitted.PricePerAdditionalMember,
                submitted.MaxTenants,
                submitted.MaxMembers,
                submitted.HasFinance,
                submitted.HasEvents,
                submitted.HasCommunication,
                submitted.HasKidsCheckin,
                "web");

            var createResult = await Sender.Send(createCommand);
            HandleResult(createResult.Success, "Plano criado.", createResult.Errors, createResult.Message);
        }

        _isSubmitting = false;
    }

    private void HandleResult(bool success, string successMessage, IReadOnlyCollection<string>? errors, string? message)
    {
        if (success)
        {
            Snackbar.Add(successMessage, Severity.Success);
            _ = LoadPlans();
        }
        else
        {
            var merged = errors is { Count: > 0 } ? string.Join("; ", errors) : message ?? "Erro";
            Snackbar.Add(merged, Severity.Error);
        }
    }

    private sealed record PlanViewModel(
        string Code,
        string Name,
        string? Description,
        decimal BasePrice,
        decimal PricePerAdditionalTenant,
        decimal PricePerAdditionalMember,
        int? MaxTenants,
        int? MaxMembers,
        IEnumerable<string> Modules,
        bool HasFinance,
        bool HasEvents,
        bool HasCommunication,
        bool HasKidsCheckin);
}
